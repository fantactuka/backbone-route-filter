(function(e){"function"==typeof define&&define.amd?define(["backbone","underscore"],e):"object"==typeof exports?module.exports=e(require("backbone"),require("underscore")):e(window.Backbone,window._)})(function(e,t){function r(e,r,n,i,u){var a=t.filter(r,function(r,o){return o=t.isRegExp(o)?o:e._routeToRegExp(o),o.test(n)});o(a,e,n,i,u)}function o(e,r,n,i,u){if(!e.length)return u.call(r),void 0;var a=e[0],c=t.tail(e),f=function(){o(c,r,n,i,u)};t.isString(a)&&(a=r[a]),3===a.length?a.apply(r,[n,i,f]):a.apply(r,[n,i])!==!1&&f()}var n=e.Router.extend;e.Router.extend=function(){var e=n.apply(this,arguments),r=e.prototype,o=this.prototype;return t.each(["before","after"],function(e){t.defaults(r[e],o[e])}),e},t.extend(e.Router.prototype,{route:function(o,n,i){t.isRegExp(o)||(o=this._routeToRegExp(o)),t.isFunction(n)&&(i=n,n=""),i||(i=this[n]);var u=this;return e.history.route(o,function(t){var a=u._extractParameters(o,t);r(u,u.before,t,a,function(){i&&i.apply(u,a),u.trigger.apply(u,["route:"+n].concat(a)),u.trigger("route",n,a),e.history.trigger("route",u,n,a),r(u,u.after,t,a,function(){})})}),this}})});